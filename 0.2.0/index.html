

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Brim.Net Core Package &mdash; Brim.Net Core Package 0.2.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Brim.Net Core Package 0.2.0 documentation" href="#" />
    <link rel="next" title="LICENSE" href="license.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="license.html" title="LICENSE"
             accesskey="N">next</a> |</li>
        <li><a href="#">Brim.Net Core Package 0.2.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="brim-net-core-package">
<h1>Brim.Net Core Package<a class="headerlink" href="#brim-net-core-package" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>Copyright 2012 Gregory Holt</p>
<p>Licensed under the Apache License, Version 2.0 (the &#8220;License&#8221;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>
<blockquote>
<div><a class="reference external" href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></div></blockquote>
<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &#8220;AS IS&#8221; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
</div></blockquote>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="license.html">LICENSE</a></li>
</ul>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This is a prerelease version of this project. As such, even as the author I don&#8217;t completely trust this code yet. It works for the specific cases I&#8217;ve tested, but it needs more use cases and time to prove itself reliable. If you find any problems or possible &#8220;oddities&#8221;, please file issues on github: <a class="reference external" href="http://github.com/gholt/brim">http://github.com/gholt/brim</a> Thanks, and be careful!</p>
</div>
<p>This is the core project for Brim.Net Python-based applications. It provides some reusable utility code and provides brimd, a launcher offering ease of deployment of WSGI applications (currently just using the Eventlet WSGI server), straight TCP and UDP socket applications, and maintaining background daemons. The brimd server will spawn subprocesses to handle requests and start daemons allowing for use of multiple CPU cores and for resiliency &#8211; when a subprocess exits without being requested to, it will be restarted automatically.</p>
<div class="section" id="required-dependencies">
<h3>Required Dependencies<a class="headerlink" href="#required-dependencies" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://python.org/">Python &gt;= 2.6</a> Not tested with Python 3 yet.</li>
<li><a class="reference external" href="http://eventlet.net/">Eventlet &gt;= 0.9.16</a></li>
<li>Unix platform: This should run on any Unix platform, though only tested on Ubuntu 10.04 LTS to date.</li>
</ul>
</div>
<div class="section" id="optional-dependencies">
<h3>Optional Dependencies<a class="headerlink" href="#optional-dependencies" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://code.google.com/p/py-setproctitle/">SetProcTitle</a> If this is installed, brimd will change its process titles to be more meaningful.</li>
<li><a class="reference external" href="https://github.com/simplejson/simplejson">SimpleJSON</a> or other JSON library containing json.dumps and json.loads compatible functions. You can configure brimd to use these alternate libraries if you wish and complying apps and daemons will also use the alternate libraries.</li>
</ul>
</div>
<div class="section" id="build-and-test-dependencies">
<h3>Build and Test Dependencies<a class="headerlink" href="#build-and-test-dependencies" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><a class="reference external" href="http://nedbatchelder.com/code/coverage/">Coverage</a> to report on test coverage.</li>
<li><a class="reference external" href="http://git-scm.com/">Git</a> since the code is hosted on <a class="reference external" href="http://github.com/gholt/brim">GitHub</a>.</li>
<li><a class="reference external" href="http://readthedocs.org/docs/nose/en/latest/">Nose</a> for the test suite.</li>
<li><cite>PIP</cite> &lt;<a class="reference external" href="http://pypi.python.org/pypi/pip">http://pypi.python.org/pypi/pip</a>&gt;`_ to install additional Python packages.</li>
<li><a class="reference external" href="http://sphinx.pocoo.org/">Sphinx</a> to build documentation.</li>
</ul>
</div>
<div class="section" id="example-install-on-ubuntu-10-04">
<h3>Example Install on Ubuntu 10.04<a class="headerlink" href="#example-install-on-ubuntu-10-04" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>$ sudo apt-get install git-core python python-pip
$ sudo pip install eventlet
$ sudo pip install setproctitle  # optional
$ git clone git://github.com/gholt/brim
$ cd brim
$ sudo python setup.py install</pre>
</div>
</div>
<div class="section" id="example-install-for-build-and-test-on-ubuntu-10-04">
<h3>Example Install for Build and Test on Ubuntu 10.04<a class="headerlink" href="#example-install-for-build-and-test-on-ubuntu-10-04" title="Permalink to this headline">¶</a></h3>
<div class="highlight-python"><pre>$ sudo apt-get install git-core python python-coverage python-nose \
  python-pip python-simplejson
$ sudo pip install eventlet
$ sudo pip install setproctitle
$ sudo pip install sphinx
$ git clone git://github.com/gholt/brim
$ cd brim
$ sudo python setup.py develop
$ python setup.py build_sphinx
$ ./.unittests</pre>
</div>
</div>
</div>
<div class="section" id="usage-examples">
<h2>Usage Examples<a class="headerlink" href="#usage-examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="example-wsgi-usage">
<h3>Example WSGI Usage<a class="headerlink" href="#example-wsgi-usage" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Create /etc/brim/brimd.conf:</p>
<div class="highlight-python"><pre>[wsgi]
apps = echo stats

[echo]
call = brim.wsgi_echo.WSGIEcho

[stats]
call = brim.stats.Stats</pre>
</div>
</li>
<li><p class="first">Start the server:</p>
<div class="highlight-python"><pre>$ sudo brimd start</pre>
</div>
</li>
<li><p class="first">Access the &#8220;echo&#8221; app (echos <em>Just a test.</em> back):</p>
<div class="highlight-python"><pre>$ curl -i http://127.0.0.1/echo --data-binary 'Just a test.'</pre>
</div>
</li>
<li><p class="first">Access a non-existent path (404s):</p>
<div class="highlight-python"><pre>$ curl -i http://127.0.0.1/invalid</pre>
</div>
</li>
<li><p class="first">Access the &#8220;stats&#8221; app (returns JSON formatted server stats):</p>
<div class="highlight-python"><pre>$ curl -s http://127.0.0.1/stats | python -mjson.tool</pre>
</div>
</li>
<li><p class="first">Stop the server:</p>
<div class="highlight-python"><pre>$ sudo brimd stop</pre>
</div>
</li>
</ul>
<p>Run <tt class="docutils literal"><span class="pre">brimd</span> <span class="pre">-h</span></tt> for more details on server control. It supports the standard init.d-style commands as well a special no-daemon mode for debugging.</p>
<p>Also, see the included brimd.conf-sample for a full set of configuration options available, such as the ip and port to use, number of subprocesses (workers), the user/group to run as, subdaemons to start, etc.</p>
</div>
<div class="section" id="example-wsgi-multi-configuration-usage">
<h3>Example WSGI Multi-Configuration Usage<a class="headerlink" href="#example-wsgi-multi-configuration-usage" title="Permalink to this headline">¶</a></h3>
<p>You can even set up multiple listening address or ports and control them with a single brimd, if you want. This can also be achieved with separate conf files and the -c and -p command line options to brimd, but most should find it easier to have one configuration with additional subconfigs. For example:</p>
<ul>
<li><p class="first">Create /etc/brim/brimd.conf:</p>
<div class="highlight-python"><pre>[wsgi]
apps = echo stats

[wsgi2]
port = 81
apps = echo2 stats

[echo]
call = brim.wsgi_echo.WSGIEcho

[stats]
call = brim.stats.Stats

[echo2]
call = brim.wsgi_echo.WSGIEcho
path = /echo2</pre>
</div>
</li>
</ul>
<p>You can see the new section [brim2] that defines the second listening port with its own configuration of the echo app and the shared stats configuration.</p>
<ul>
<li><p class="first">Start the server:</p>
<div class="highlight-python"><pre>$ sudo brimd start</pre>
</div>
</li>
<li><p class="first">Access the &#8220;echo&#8221; app on the main port:</p>
<div class="highlight-python"><pre>$ curl -i http://127.0.0.1/echo --data-binary 'Just a test.'</pre>
</div>
</li>
<li><p class="first">Access the &#8220;echo&#8221; app on the second port:</p>
<div class="highlight-python"><pre>$ curl -i http://127.0.0.1:81/echo2 --data-binary 'Just a test.'</pre>
</div>
</li>
<li><p class="first">Note that the apps don&#8217;t answer on the other ports:</p>
<div class="highlight-python"><pre>$ curl -i http://127.0.0.1/echo2 --data-binary 'Just a test.'
$ curl -i http://127.0.0.1:81/echo --data-binary 'Just a test.'</pre>
</div>
</li>
<li><p class="first">Access the &#8220;stats&#8221; app and see it&#8217;s configured on both ports:</p>
<div class="highlight-python"><pre>$ curl -s http://127.0.0.1/stats | python -mjson.tool
$ curl -s http://127.0.0.1:81/stats | python -mjson.tool</pre>
</div>
</li>
<li><p class="first">Stop the server:</p>
<div class="highlight-python"><pre>$ sudo brimd stop</pre>
</div>
</li>
</ul>
<p>The included brimd.conf-sample shows a full set of configuration options available for each subconfig and explains how the defaults usually fall back to the main conf.</p>
</div>
<div class="section" id="example-tcp-straight-socket-application-usage">
<h3>Example TCP Straight Socket Application Usage<a class="headerlink" href="#example-tcp-straight-socket-application-usage" title="Permalink to this headline">¶</a></h3>
<p>TODO: For now, see the [tcp] section in the brimd.conf-sample and the brim.tcp_echo.py sample application.</p>
<p>The included brimd.conf-sample shows a full set of configuration options available for each subconfig and explains how the defaults usually fall back to the main conf.</p>
</div>
<div class="section" id="example-udp-application-usage">
<h3>Example UDP Application Usage<a class="headerlink" href="#example-udp-application-usage" title="Permalink to this headline">¶</a></h3>
<p>TODO: For now, see the [udp] section in the brimd.conf-sample and the brim.udp_echo.py sample application.</p>
<p>The included brimd.conf-sample shows a full set of configuration options available for each subconfig and explains how the defaults usually fall back to the main conf.</p>
</div>
<div class="section" id="example-daemon-usage">
<h3>Example Daemon Usage<a class="headerlink" href="#example-daemon-usage" title="Permalink to this headline">¶</a></h3>
<p>The brimd server can manage additional daemons as well as the main WSGI server. You configure them much like WSGI apps, but with the daemons configuration value. There is a brim.daemon_sample.DaemonSample that can be a good start for writing new daemons.</p>
<p>Here&#8217;s an example brimd.conf that starts the sample daemon:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">daemons</span><span class="p">]</span>
<span class="n">daemons</span> <span class="o">=</span> <span class="n">sample</span>

<span class="p">[</span><span class="n">sample</span><span class="p">]</span>
<span class="n">call</span> <span class="o">=</span> <span class="n">brim</span><span class="o">.</span><span class="n">daemon_sample</span><span class="o">.</span><span class="n">DaemonSample</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="development-examples">
<h2>Development Examples<a class="headerlink" href="#development-examples" title="Permalink to this headline">¶</a></h2>
<div class="section" id="wsgi-application-development">
<h3>WSGI Application Development<a class="headerlink" href="#wsgi-application-development" title="Permalink to this headline">¶</a></h3>
<p>Developing WSGI applications for brimd is quite similar to other Python WSGI servers. Here&#8217;s a simple example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HelloWorld</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">next_app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_app</span> <span class="o">=</span> <span class="n">next_app</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;/helloworld&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_app</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="s">&#39;Hello World!</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)))])</span>
        <span class="k">return</span> <span class="n">body</span>
</pre></div>
</div>
<p>Here&#8217;s an example /etc/brim/brimd.conf with this app active:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">brimd</span><span class="p">]</span>
<span class="n">wsgi</span> <span class="o">=</span> <span class="n">helloworld</span>

<span class="p">[</span><span class="n">helloworld</span><span class="p">]</span>
<span class="n">call</span> <span class="o">=</span> <span class="n">mypackage</span><span class="o">.</span><span class="n">mymodule</span><span class="o">.</span><span class="n">HelloWorld</span>
</pre></div>
</div>
<p>We can then start the server and access the new app:</p>
<div class="highlight-python"><pre>$ sudo brimd restart
$ curl -i http://127.0.0.1/helloworld
HTTP/1.1 200 OK
Content-Length: 13
Date: Sat, 14 Jan 2012 22:57:38 GMT

Hello World!</pre>
</div>
<p>The <tt class="docutils literal"><span class="pre">__call__</span></tt> method is the usual WSGI (env, start_response) call made per incoming request.</p>
<p>The <tt class="docutils literal"><span class="pre">__init__</span></tt> is a little different for brimd and takes the name of the app as configured in the brimd.conf file, the full brimd configuration object as an instance of brim.conf.Conf, and the next WSGI app in the chain (the last app in the chain will always be brimd itself).</p>
<p>The name lets you know which part of the conf to access for any app-specific configuration, though you can always stray outside just that section if needed.</p>
<p>The conf, while by default is the full server brim.conf.Conf instance, it can be pre-parsed if desired. This is useful if you want to raise an exception if the configuration is invalid, preventing the server from starting with an explanatory message. Otherwise, once your app&#8217;s <tt class="docutils literal"><span class="pre">__init__</span></tt> method is called, you should not raise any exceptions unless something goes horribly wrong, as brimd will just keep restarting your app to try to keep it running.</p>
<p>To pre-parse the configuration, you just add a class method of parse_conf that takes the brim.conf.Conf instance and returns whatever you want as the conf argument to your constructor. To continue our example, we&#8217;ll look for a path in the config and exit if it doesn&#8217;t exist:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">HelloWorld</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">next_app</span><span class="p">):</span>
        <span class="c"># conf is what was returned from parse_conf now.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_app</span> <span class="o">=</span> <span class="n">next_app</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_app</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="n">body</span> <span class="o">=</span> <span class="s">&#39;Hello World!</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)))])</span>
        <span class="k">return</span> <span class="n">body</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_conf</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%s</span><span class="s">] you must configure a path to serve.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>
</pre></div>
</div>
<p>Now, let&#8217;s restart the server without yet updating the config and see what happens:</p>
<div class="highlight-python"><pre>$ sudo brimd restart
[helloworld] you must configure a path to serve.</pre>
</div>
<p>It&#8217;s important to note that this early config parsing is done in the main server process before any subprocesses are launched. Anything loaded into memory will copied into the subprocesses&#8217; memory as well. So, to reiterate, <tt class="docutils literal"><span class="pre">parse_conf</span></tt> is called in the main process and <tt class="docutils literal"><span class="pre">__init__</span></tt> is called in each subprocess.</p>
<p>Now, let&#8217;s update our configuration:</p>
<div class="highlight-python"><pre>[brimd]
wsgi = helloworld

[helloworld]
call = mypackage.mymodule.HelloWorld
path = /here</pre>
</div>
<p>And now try using our app again:</p>
<div class="highlight-python"><pre>$ sudo brimd restart
$ curl -i http://127.0.0.1/here
HTTP/1.1 200 OK
Content-Length: 13
Date: Sat, 14 Jan 2012 23:05:20 GMT

Hello World!</pre>
</div>
<p>To continue our example, let&#8217;s add stats to our application. We&#8217;ll count how many times we&#8217;re called and the last time we were called:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>


<span class="k">class</span> <span class="nc">HelloWorld</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">next_app</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">conf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_app</span> <span class="o">=</span> <span class="n">next_app</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">env</span><span class="p">[</span><span class="s">&#39;PATH_INFO&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_app</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
        <span class="c"># Here&#39;s where we update the stats.</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;brim.stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.requests&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">env</span><span class="p">[</span><span class="s">&#39;brim.stats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.last_called&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">())</span>
        <span class="n">body</span> <span class="o">=</span> <span class="s">&#39;Hello World!</span><span class="se">\n</span><span class="s">&#39;</span>
        <span class="n">start_response</span><span class="p">(</span><span class="s">&#39;200 OK&#39;</span><span class="p">,</span> <span class="p">[(</span><span class="s">&#39;Content-Length&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)))])</span>
        <span class="k">return</span> <span class="n">body</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parse_conf</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;[</span><span class="si">%s</span><span class="s">] you must configure a path to serve.&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">stats_conf</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="p">):</span>
        <span class="c"># This is the new class method to configure additional stats, it</span>
        <span class="c"># returns a list of (stat_name, stat_type) tuples.</span>
        <span class="k">return</span> <span class="p">[(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.requests&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="s">&#39;sum&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">.last_called&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span> <span class="s">&#39;max&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>You can see that we configure the stats with the new stats_conf class method. The method returns a list of (stat_name, stat_type) pairs. stat_name is the str name of the stat and stat_type is one of the following:</p>
<blockquote>
<div><p>worker</p>
<blockquote>
<div>Indicates a worker only stat. No overall stat will be reported.</div></blockquote>
<p>sum</p>
<blockquote>
<div>Indicates an overall stat should be reported that is a sum of the stat from all workers.</div></blockquote>
<p>min</p>
<blockquote>
<div>Indicates an overall stat should be reported that is the smallest value of the stat from all workers.</div></blockquote>
<p>max</p>
<blockquote>
<div>Indicates an overall stat should be reported that is the largest value of the stat from all workers.</div></blockquote>
</div></blockquote>
<p>When handling actual requests, we can access the stats via the <tt class="docutils literal"><span class="pre">env['brim.stats']</span></tt> object, which supports the following methods:</p>
<blockquote>
<div><p>get(&lt;name&gt;)</p>
<blockquote>
<div>Return the int value of the stat &lt;name&gt;.</div></blockquote>
<p>set(&lt;name&gt;, value)</p>
<blockquote>
<div>Sets the value of the stat &lt;name&gt;. The value will be treated as an unsigned integer.</div></blockquote>
<p>incr(&lt;name&gt;)</p>
<blockquote>
<div>Increments the value of the stat &lt;name&gt; by 1.</div></blockquote>
</div></blockquote>
<p>So now, let&#8217;s add the brim.stats.Stats app to our configuration so we&#8217;ll be able to get a report on the server stats:</p>
<div class="highlight-python"><pre>[brimd]
wsgi = helloworld stats

[helloworld]
call = mypackage.mymodule.HelloWorld
path = /here

[stats]
call = brim.stats.Stats</pre>
</div>
<p>Let&#8217;s try it out:</p>
<div class="highlight-python"><pre>$ sudo brimd restart
$ curl http://127.0.0.1/here
Hello World!
$ curl -s http://127.0.0.1/stats | python -mjson.tool
...
"helloworld.last_called": 1326602976,
"helloworld.requests": 1,
...
"0": {
    "helloworld.last_called": 1,
    "helloworld.requests": 1326602976,
...
$ curl http://127.0.0.1/here
Hello World!
$ curl http://127.0.0.1/here
Hello World!
$ curl -s http://127.0.0.1/stats | python -mjson.tool
...
"helloworld.last_called": 1326603159,
"helloworld.requests": 3,
...
"0": {
    "helloworld.last_called": 3,
    "helloworld.requests": 1326603159,
...</pre>
</div>
<p>Of course, we only have one worker so the overall stats just mirror that worker. You can add <tt class="docutils literal"><span class="pre">workers</span> <span class="pre">=</span> <span class="pre">&lt;number&gt;</span></tt> to your brimd.conf if you want more workers.</p>
<div class="section" id="extra-wsgi-env-items">
<h4>Extra WSGI env Items<a class="headerlink" href="#extra-wsgi-env-items" title="Permalink to this headline">¶</a></h4>
<p>brim</p>
<blockquote>
<div>This is the brim.server.Server instance itself. Normally you don&#8217;t need access to this, but some apps like brim.stats.Stats do.</div></blockquote>
<p>brim.start</p>
<blockquote>
<div>The time.time() the request started processing.</div></blockquote>
<p>brim.logger</p>
<blockquote>
<div>A logging.Logger instance for most logging needs. This logger can be configured in brimd.conf and by default it logs at the INFO level and above to syslog&#8217;s LOCAL0 facility. Note that the server automatically logs request/responses at the NOTICE level, so you don&#8217;t have to.</div></blockquote>
<p>brim.txn</p>
<blockquote>
<div>A uuid.uuid4().hex value to unique identify the request. This can be very useful when logging so that you can track what a request is doing on a busy server. This is automatically added to every log line the brim.logger logs.</div></blockquote>
<p>brim.additional_request_log_info</p>
<blockquote>
<div><p>A list of strings that will be appended to the request log line that brimd generates. This can be useful for identifying requests or what actions requests may have taken.</p>
<p>It&#8217;s usually best to add your app&#8217;s info all at once with a prefix word, like:</p>
<p><tt class="docutils literal"><span class="pre">env['brim.additional_request_log_info'].extend(['myapp:',</span> <span class="pre">'myinfo1',</span> <span class="pre">'myinfo2'])</span></tt></p>
<p>You could just add it all as one word <tt class="docutils literal"><span class="pre">.append('myapp:</span> <span class="pre">myinfo1</span> <span class="pre">myinfo2')</span></tt> but understand that this will encode the spaces to %20 on the log line.</p>
</div></blockquote>
<p>brim.stats</p>
<blockquote>
<div><p>An object that gives access to server stats. Which stats are available is determined by the server configuration, and specifically by each app&#8217;s stats_conf class method. See the brim.wsgi_echo.WSGIEcho and brim.stats.Stats apps for examples of how to use these stats. This stats object will implement the following methods:</p>
<blockquote>
<div><p>get(&lt;name&gt;)</p>
<blockquote>
<div>Return the int value of the stat &lt;name&gt;.</div></blockquote>
<p>set(&lt;name&gt;, int)</p>
<blockquote>
<div>Sets the in value of the stat &lt;name&gt;. The value will be treated as unsigned.</div></blockquote>
<p>incr(&lt;name&gt;)</p>
<blockquote>
<div>Increments the value of the stat &lt;name&gt; by 1.</div></blockquote>
</div></blockquote>
</div></blockquote>
<div class="line-block">
<div class="line">brim.json_dumps</div>
<div class="line">brim.json_loads</div>
</div>
<blockquote>
<div>These are the JSON dumps and loads functions for converting to and from JSON and Python objects. By default, these are json.dumps and json.loads, but faster libraries are out there and can be configured in brimd.conf. Using these env items means you&#8217;ll automatically use whatever is configured.</div></blockquote>
</div>
<div class="section" id="server-stats">
<h4>Server Stats<a class="headerlink" href="#server-stats" title="Permalink to this headline">¶</a></h4>
<p>The brimd server tracks various statistics, such as the server start time and number of requests processed. The brim.stats.Stats app can be configured to provide access to these stats via a JSON response:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">brim</span><span class="p">]</span>
<span class="n">wsgi</span> <span class="o">=</span> <span class="n">stats</span>
<span class="n">workers</span> <span class="o">=</span> <span class="mi">4</span>

<span class="p">[</span><span class="n">stats</span><span class="p">]</span>
<span class="n">call</span> <span class="o">=</span> <span class="n">brim</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">Stats</span>
<span class="c"># path = &lt;path&gt;</span>
<span class="c">#   The request path to match and serve; any other paths will be passed on</span>
<span class="c">#   to the next WSGI app in the chain. This can serve as a basic</span>
<span class="c">#   restriction to accessing the stats by setting it to a hard to guess</span>
<span class="c">#   value. Default: /stats</span>
</pre></div>
</div>
<p>TODO: Update this:
After restarting the server, you can now access these stats:</p>
<div class="highlight-python"><pre>$ curl s- http://127.0.0.1/stats | python -mjson.tool
{
    "request_count": 18317,
    "start_time": 1326585797,
    "status_2xx_count": 14326,
    "status_3xx_count": 0,
    "status_404_count": 3991,
    "status_408_count": 0,
    "status_499_count": 0,
    "status_4xx_count": 3991,
    "status_501_count": 0,
    "status_5xx_count": 0,
    "worker_0": {
        "request_count": 4698,
        "start_time": 1326585797,
        "status_2xx_count": 3742,
        "status_3xx_count": 0,
        "status_404_count": 956,
        "status_408_count": 0,
        "status_499_count": 0,
        "status_4xx_count": 956,
        "status_501_count": 0,
        "status_5xx_count": 0
    },
    "worker_1": {
        "request_count": 4467,
        "start_time": 1326585797,
        "status_2xx_count": 3475,
        "status_3xx_count": 0,
        "status_404_count": 992,
        "status_408_count": 0,
        "status_499_count": 0,
        "status_4xx_count": 992,
        "status_501_count": 0,
        "status_5xx_count": 0
    },
    "worker_2": {
        "request_count": 4497,
        "start_time": 1326585797,
        "status_2xx_count": 3505,
        "status_3xx_count": 0,
        "status_404_count": 992,
        "status_408_count": 0,
        "status_499_count": 0,
        "status_4xx_count": 992,
        "status_501_count": 0,
        "status_5xx_count": 0
    },
    "worker_3": {
        "request_count": 4655,
        "start_time": 1326585797,
        "status_2xx_count": 3604,
        "status_3xx_count": 0,
        "status_404_count": 1051,
        "status_408_count": 0,
        "status_499_count": 0,
        "status_4xx_count": 1051,
        "status_501_count": 0,
        "status_5xx_count": 0
    }
}</pre>
</div>
<p>Notice there are overall server stats and individual worker stats. Here is what&#8217;s available by default (apps can configure additional stats):</p>
<p>request_count</p>
<blockquote>
<div>This is the number of requests served by the server and is simply a sum of all the worker&#8217;s request_counts.</div></blockquote>
<p>start_time</p>
<blockquote>
<div>This is the int(time.time()) the server was started. Each worker also has a start_time that indicates when that subprocess was started. If a subprocess crashes and restarts, this start_time will be different than the overall server start_time.</div></blockquote>
<div class="line-block">
<div class="line">status_2xx_count</div>
<div class="line">status_3xx_count</div>
<div class="line">status_4xx_count</div>
<div class="line">status_5xx_count</div>
</div>
<blockquote>
<div>These are the counts of requests that returned the response code ranges stated. For example, a high status_5xx_count can indicate a major server problem.</div></blockquote>
<div class="line-block">
<div class="line">status_404_count</div>
<div class="line">status_408_count</div>
<div class="line">etc.</div>
</div>
<blockquote>
<div>These track specific response codes. Which response codes are tracked can be configured in brimd.conf, but are 404, 408, 499, and 501 by default. A high 404 count on a server that normally shouldn&#8217;t do so can indicate missing files or a bad incoming link. 408 Request Timeout and 499 Disconnect can indicate network problems or perhaps too aggressive timeouts. 501 Not Implemented counts can often be subtracted from the status_5xx_count to get a true count of real server problems.</div></blockquote>
</div>
</div>
<div class="section" id="tcp-straight-socket-application-development">
<h3>TCP Straight Socket Application Development<a class="headerlink" href="#tcp-straight-socket-application-development" title="Permalink to this headline">¶</a></h3>
<p>TODO: For now, see the [tcp] section in the brimd.conf-sample and the brim.tcp_echo.py sample application.</p>
</div>
<div class="section" id="udp-socket-application-development">
<h3>UDP Socket Application Development<a class="headerlink" href="#udp-socket-application-development" title="Permalink to this headline">¶</a></h3>
<p>TODO: For now, see the [udp] section in the brimd.conf-sample and the brim.udp_echo.py sample application.</p>
</div>
<div class="section" id="daemon-development">
<h3>Daemon Development<a class="headerlink" href="#daemon-development" title="Permalink to this headline">¶</a></h3>
<p>TODO: For now, see the [daemons] section in the brimd.conf-sample and the brim.daemon_sample.py sample application.</p>
</div>
</div>
<div class="section" id="code-generated-documentation">
<h2>Code-Generated Documentation<a class="headerlink" href="#code-generated-documentation" title="Permalink to this headline">¶</a></h2>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="brim.html">brim</a></li>
<li class="toctree-l1"><a class="reference internal" href="brim.html#module-brim.conf">brim.conf</a></li>
<li class="toctree-l1"><a class="reference internal" href="brim.html#module-brim.http">brim.http</a></li>
<li class="toctree-l1"><a class="reference internal" href="brim.html#module-brim.log">brim.log</a></li>
<li class="toctree-l1"><a class="reference internal" href="brim.html#module-brim.daemon_sample">brim.daemon_sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="brim.html#module-brim.server">brim.server</a></li>
<li class="toctree-l1"><a class="reference internal" href="brim.html#module-brim.service">brim.service</a></li>
<li class="toctree-l1"><a class="reference internal" href="brim.html#module-brim.stats">brim.stats</a></li>
<li class="toctree-l1"><a class="reference internal" href="brim.html#module-brim.tcp_echo">brim.tcp_echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="brim.html#module-brim.udp_echo">brim.udp_echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="brim.html#module-brim.util">brim.util</a></li>
<li class="toctree-l1"><a class="reference internal" href="brim.html#module-brim.wsgi_echo">brim.wsgi_echo</a></li>
</ul>
</div>
</div>
<div class="section" id="indices-and-tables">
<h2>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference internal" href="genindex.html"><em>Index</em></a></li>
<li><a class="reference internal" href="py-modindex.html"><em>Module Index</em></a></li>
<li><a class="reference internal" href="search.html"><em>Search Page</em></a></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="#">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Brim.Net Core Package</a><ul>
<li><a class="reference internal" href="#overview">Overview</a><ul>
<li><a class="reference internal" href="#required-dependencies">Required Dependencies</a></li>
<li><a class="reference internal" href="#optional-dependencies">Optional Dependencies</a></li>
<li><a class="reference internal" href="#build-and-test-dependencies">Build and Test Dependencies</a></li>
<li><a class="reference internal" href="#example-install-on-ubuntu-10-04">Example Install on Ubuntu 10.04</a></li>
<li><a class="reference internal" href="#example-install-for-build-and-test-on-ubuntu-10-04">Example Install for Build and Test on Ubuntu 10.04</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage-examples">Usage Examples</a><ul>
<li><a class="reference internal" href="#example-wsgi-usage">Example WSGI Usage</a></li>
<li><a class="reference internal" href="#example-wsgi-multi-configuration-usage">Example WSGI Multi-Configuration Usage</a></li>
<li><a class="reference internal" href="#example-tcp-straight-socket-application-usage">Example TCP Straight Socket Application Usage</a></li>
<li><a class="reference internal" href="#example-udp-application-usage">Example UDP Application Usage</a></li>
<li><a class="reference internal" href="#example-daemon-usage">Example Daemon Usage</a></li>
</ul>
</li>
<li><a class="reference internal" href="#development-examples">Development Examples</a><ul>
<li><a class="reference internal" href="#wsgi-application-development">WSGI Application Development</a><ul>
<li><a class="reference internal" href="#extra-wsgi-env-items">Extra WSGI env Items</a></li>
<li><a class="reference internal" href="#server-stats">Server Stats</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tcp-straight-socket-application-development">TCP Straight Socket Application Development</a></li>
<li><a class="reference internal" href="#udp-socket-application-development">UDP Socket Application Development</a></li>
<li><a class="reference internal" href="#daemon-development">Daemon Development</a></li>
</ul>
</li>
<li><a class="reference internal" href="#code-generated-documentation">Code-Generated Documentation</a><ul>
</ul>
</li>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>
</li>
</ul>

  <h4>Next topic</h4>
  <p class="topless"><a href="license.html"
                        title="next chapter">LICENSE</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/index.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="license.html" title="LICENSE"
             >next</a> |</li>
        <li><a href="#">Brim.Net Core Package 0.2.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Gregory Holt.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>